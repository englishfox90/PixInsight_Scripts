/*
 * SNRAnalysis-results-dialog.js
 * Results presentation dialogs for single and multi-filter analysis
 */

/**
 * Show single-filter results dialog
 * @param {Array} results - Array of integration depth result objects
 * @param {number} totalTimeSec - Total analysis runtime in seconds
 * @param {string} outputDir - Output directory path
 * @param {string} graphPath - Optional path to graph image file
 */
function showResultsDialog(results, totalTimeSec, outputDir, graphPath, gainGraphPathParam, insights) {
   var dialog = new Dialog();
   dialog.windowTitle = "SNR Analysis Complete";
   dialog.scaledMinWidth = 1000;
   dialog.scaledMinHeight = 1250;
   
   // Results summary
   var summaryText = new TextBox(dialog);
   summaryText.readOnly = true;
   summaryText.styleSheet = "font-family: monospace; font-size: 10pt;";
   summaryText.setScaledMinSize(950, 415);
   
   var text = "=== SNR ANALYSIS RESULTS ===\n\n";

   // Calculate overall improvement
   if (results.length >= 2) {
      var firstSNR = results[0].snr;
      var lastSNR = results[results.length - 1].snr;
      var totalImprovement = ((lastSNR - firstSNR) / firstSNR) * 100;
      var snrMultiplier = lastSNR / firstSNR;
      
      text += "OVERALL IMPROVEMENT:\n";
      text += "  " + results[0].label + " → " + results[results.length - 1].label + "\n";
      text += "  SNR: " + firstSNR.toFixed(2) + " → " + lastSNR.toFixed(2) + "\n";
      text += "  ★ " + totalImprovement.toFixed(1) + "% better (" + snrMultiplier.toFixed(2) + "x increase)\n\n";
   }
   
   // Part E - Clarify signal scale locking if enabled
   var lockScaleEnabled = (results.length > 0 && results[0].scaleFactor !== undefined && results[0].scaleFactor !== 1.0);
   if (lockScaleEnabled) {
      text += "  ★ Signal scale locked to reference background for consistent measurement\n";
      text += "  ★ All integrations normalized before SNR calculation\n";
   }
   text += "\n";

   text += "Analyzed " + results.length + " integration depths\n";
   text += "Total runtime: " + formatTime(totalTimeSec) + "\n\n";
   
   text += "Label        N Subs    Total Exp               SNR      Improvement    Gain/hr\n";
   text += "------------------------------------------------------------------------------------\n";
   
   for (var i = 0; i < results.length; i++) {
      var r = results[i];
      var deltaSNR = "";
      var gainHrStr = "--";
      
      if (i > 0) {
         var delta = ((r.snr - results[i-1].snr) / results[i-1].snr) * 100;
         var arrow = delta > 50 ? "↑↑" : delta > 20 ? "↑ " : delta > 0 ? "↗ " : "→ ";
         deltaSNR = arrow + (delta >= 0 ? "+" : "") + delta.toFixed(1) + "%";
         if (r.gainPerHour !== null && r.gainPerHour !== undefined) {
            gainHrStr = r.gainPerHour.toFixed(1) + "%/h";
         }
      } else {
         deltaSNR = "(baseline)";
      }
      
      var line = padRight(r.label, 12) + " " + 
              padLeft(r.depth.toString(), 6) + "    " +
              padLeft(formatTime(r.totalExposure), 20) + "    " +
              padLeft(r.snr.toFixed(2), 6) + "    " +
              padLeft(deltaSNR, 14) + "   " +
              padLeft(gainHrStr, 10) + "\n";
      text += line;
   }
   
   text += "\n=== INSIGHTS ===\n\n";
   
   if (insights && insights.summary) {
      // Use the comprehensive summary generated by generateInsightsSummary()
      text += insights.summary;
   }
   
   text += "\n=== OUTPUT FILES ===\n\n";
   text += "Base Location: " + CONFIG.baseAnalysisDir + "\n\n";
   text += "Data (CSV/JSON):\n";
   text += "  \u2022 data/snr_results.csv - Full data for spreadsheet analysis\n";
   text += "  \u2022 data/snr_results.json - Structured data with insights\n\n";
   text += "Graphs:\n";
   text += "  \u2022 graphs/snr_graph.png - SNR vs integration time\n";
   text += "  \u2022 graphs/gain_graph.png - Gain/hr vs integration time\n\n";
   text += "Integrations:\n";
   text += "  \u2022 integrations/int_NX.xisf - Integrated files for each depth\n\n";
   text += "Previews:\n";
   text += "  \u2022 previews/int_NX_starless.xisf - Starless versions\n";
   
   summaryText.text = text;
   
   // Create preview TabBox to hold Graph and Stack preview
   var previewTabBox = new TabBox(dialog);
   
   // Tab 1: Graph Preview with dropdown selector
   var graphTab = new Control(dialog);
   graphTab.sizer = new VerticalSizer;
   graphTab.sizer.margin = 6;
   graphTab.sizer.spacing = 4;
   
   // Graph type selector row
   var graphSelectorSizer = new HorizontalSizer;
   graphSelectorSizer.spacing = 6;
   
   var graphTypeLabel = new Label(graphTab);
   graphTypeLabel.text = "Graph Type:";
   graphTypeLabel.textAlignment = TextAlign_Left | TextAlign_VertCenter;
   graphTypeLabel.minWidth = 80;
   
   var graphTypeCombo = new ComboBox(graphTab);
   graphTypeCombo.addItem("SNR vs Time");
   graphTypeCombo.addItem("Gain/hr vs Time");
   graphTypeCombo.currentItem = 0;
   graphTypeCombo.minWidth = 150;
   
   graphSelectorSizer.add(graphTypeLabel);
   graphSelectorSizer.add(graphTypeCombo);
   graphSelectorSizer.addStretch();
   
   graphTab.sizer.add(graphSelectorSizer);
   
   // Graph preview ScrollBox
   var graphPreview = new ScrollBox(graphTab);
   graphPreview.autoScroll = true;
   graphPreview.setScaledMinSize(780, 390);
   graphPreview.setScaledMaxSize(780, 390);
   
   // Store both graph paths
   var snrGraphPath = graphPath;
   var gainGraphPath = gainGraphPathParam;
   
   // Debug: Show what paths were passed
   console.writeln("Graph paths received - SNR: " + (snrGraphPath || "null") + ", Gain: " + (gainGraphPath || "null"));
   
   // Try to find SNR graph if not provided
   if (!snrGraphPath) {
      snrGraphPath = CONFIG.graphsDir + "/snr_graph.png";
      if (!File.exists(snrGraphPath)) {
         snrGraphPath = CONFIG.graphsDir + "/snr_graph.jpg";
      }
      if (!File.exists(snrGraphPath)) {
         snrGraphPath = CONFIG.graphsDir + "/snr_graph.bmp";
      }
      console.writeln("SNR graph fallback search result: " + snrGraphPath);
   }
   
   // Try to find Gain/hr graph if not provided
   if (!gainGraphPath) {
      gainGraphPath = CONFIG.graphsDir + "/gain_graph.png";
      if (!File.exists(gainGraphPath)) {
         gainGraphPath = CONFIG.graphsDir + "/gain_graph.jpg";
      }
      if (!File.exists(gainGraphPath)) {
         gainGraphPath = CONFIG.graphsDir + "/gain_graph.bmp";
      }
      console.writeln("Gain graph fallback search result: " + gainGraphPath);
   }
   
   // Load both graphs
   var snrGraphBitmap = null;
   var gainGraphBitmap = null;
   
   if (snrGraphPath && File.exists(snrGraphPath)) {
      try {
         snrGraphBitmap = new Bitmap(snrGraphPath);
         console.writeln("SNR graph loaded: " + snrGraphPath);
      } catch (e) {
         console.warningln("Failed to load SNR graph: " + e.message);
      }
   }
   
   if (gainGraphPath && File.exists(gainGraphPath)) {
      try {
         gainGraphBitmap = new Bitmap(gainGraphPath);
         console.writeln("Gain/hr graph loaded: " + gainGraphPath);
      } catch (e) {
         console.warningln("Failed to load Gain/hr graph: " + e.message);
      }
   }
   
   // Store bitmaps for switching
   graphPreview.snrBitmap = snrGraphBitmap;
   graphPreview.gainBitmap = gainGraphBitmap;
   graphPreview.currentBitmap = snrGraphBitmap;
   graphPreview.statusText = snrGraphBitmap ? "" : "SNR graph not available";
   
   // Viewport paint handler
   graphPreview.viewport.onPaint = function(x0, y0, x1, y1) {
      var g = new Graphics(this);
      var bmp = this.parent.currentBitmap;
      
      if (bmp && bmp.width > 0 && bmp.height > 0) {
         // Fill background (white)
         g.fillRect(x0, y0, x1, y1, new Brush(0xFFFFFFFF));
         
         // Calculate scale to fit viewport
         var maxWidth = 760;
         var maxHeight = 370;
         var scale = Math.min(maxWidth / bmp.width, maxHeight / bmp.height, 1.0);
         var scaledWidth = Math.floor(bmp.width * scale);
         var scaledHeight = Math.floor(bmp.height * scale);
         
         // Center the scaled bitmap
         var xOffset = Math.max(0, (this.width - scaledWidth) / 2);
         var yOffset = Math.max(0, (this.height - scaledHeight) / 2);
         
         // Draw scaled bitmap
         g.drawScaledBitmap(xOffset, yOffset, xOffset + scaledWidth, yOffset + scaledHeight, bmp);
      } else {
         // No graph available
         g.fillRect(x0, y0, x1, y1, new Brush(0xFFFFFFFF));
         g.pen = new Pen(0xFF000000);
         g.font = new Font("helvetica", 12);
         var statusText = this.parent.statusText || "Graph not available";
         g.drawText(20, 30, statusText);
      }
      
      g.end();
   };
   
   // Graph type combo change handler
   graphTypeCombo.onItemSelected = function(index) {
      if (index === 0) {
         // SNR graph
         graphPreview.currentBitmap = graphPreview.snrBitmap;
         graphPreview.statusText = graphPreview.snrBitmap ? "" : "SNR graph not available";
      } else {
         // Gain/hr graph
         graphPreview.currentBitmap = graphPreview.gainBitmap;
         graphPreview.statusText = graphPreview.gainBitmap ? "" : "Gain/hr graph not available";
      }
      graphPreview.viewport.update();
   };
   
   graphTab.sizer.add(graphPreview)
   
   previewTabBox.addPage(graphTab, "Graph");
   
   // Tab 2: Stack Preview
   var stackTab = createStackPreviewPanel(
      dialog,
      createStackPreviewEntries(results, null, "", CONFIG.generateStarless),
      false,  // Always full-frame mode
      ""
   );
   
   previewTabBox.addPage(stackTab, "Stack Preview");
   
   // Default to Graph tab
   previewTabBox.currentPageIndex = 0;
   
   // Buttons
   var buttonSizer = new HorizontalSizer;
   buttonSizer.spacing = 6;
   buttonSizer.addStretch();
   
   var okButton = new PushButton(dialog);
   okButton.text = "OK";
   okButton.icon = dialog.scaledResource(":/icons/ok.png");
   okButton.onClick = function() {
      dialog.ok();
   };
   buttonSizer.add(okButton);
   
   // Layout
   dialog.sizer = new VerticalSizer;
   dialog.sizer.margin = 8;
   dialog.sizer.spacing = 6;
   dialog.sizer.add(summaryText);
   dialog.sizer.add(previewTabBox);
   dialog.sizer.add(buttonSizer);
   
   dialog.execute();
}

/**
 * Show multi-filter results dialog with tabs for each filter
 * @param {Array} allFilterResults - Array of {filterName, results, rois, insights, totalTime, graphPath}
 * @param {string} outputDir - Output directory
 */
function showMultiFilterResultsDialog(allFilterResults, outputDir) {
   // Multi-filter tabbed dialog
   var dialog = new Dialog();
   dialog.windowTitle = "SNR Analysis Complete - Multiple Filters";
   
   var tabBox = new TabBox(dialog);
   
   // Create a tab for each filter
   for (var i = 0; i < allFilterResults.length; i++) {
      var fr = allFilterResults[i];
      var tabPage = new Control(dialog);
      tabPage.sizer = new VerticalSizer;
      tabPage.sizer.margin = 8;
      tabPage.sizer.spacing = 6;
      
      // Summary text
      var summaryText = new TextBox(tabPage);
      summaryText.readOnly = true;
      summaryText.styleSheet = "QTextEdit { font-family: 'Courier New', monospace; font-size: 10pt; }";
      summaryText.setScaledMinSize(750, 340);
      
      var summaryContent = "";
      summaryContent += "SNR Analysis Results - " + fr.filterName + "\n";
      summaryContent += "=".repeat(80) + "\n\n";

      // Calculate overall improvement for this filter
      if (fr.results.length >= 2) {
         var firstSNR = fr.results[0].snr;
         var lastSNR = fr.results[fr.results.length - 1].snr;
         var totalImprovement = ((lastSNR - firstSNR) / firstSNR) * 100;
         var snrMultiplier = lastSNR / firstSNR;
         
         summaryContent += "OVERALL IMPROVEMENT:\n";
         summaryContent += "  " + fr.results[0].label + " → " + fr.results[fr.results.length - 1].label + "\n";
         summaryContent += "  SNR: " + firstSNR.toFixed(2) + " → " + lastSNR.toFixed(2) + "\n";
         summaryContent += "  ★ " + totalImprovement.toFixed(1) + "% better (" + snrMultiplier.toFixed(2) + "x increase)\n\n";
      }
      
      // Part E - Clarify signal scale locking if enabled
      var lockScaleEnabled = (fr.results.length > 0 && fr.results[0].scaleFactor !== undefined && fr.results[0].scaleFactor !== 1.0);
      if (lockScaleEnabled) {
         summaryContent += "  ★ Signal scale locked to reference background for consistent measurement\n";
         summaryContent += "  ★ All integrations normalized before SNR calculation\n";
      }
      summaryContent += "\n";
      
      summaryContent += "Output Directory: " + outputDir + "\n";
      summaryContent += "Total Runtime: " + formatTime(fr.totalTime) + "\n";
      summaryContent += "Depths Analyzed: " + fr.results.length + "\n\n";
      
      summaryContent += padRight("Label", 12) + padRight("N Subs", 10) + padRight("Total Exp", 15) + 
                       padRight("SNR", 10) + padRight("Improvement", 14) + padRight("Gain/hr", 11) + "Timings\n";
      summaryContent += "-".repeat(91) + "\n";
      
      for (var j = 0; j < fr.results.length; j++) {
         var r = fr.results[j];
         var totalExpStr = formatTime(r.totalExposure);
         var timingsStr = "int:" + r.integrationTime.toFixed(1) + "s star:" + r.starRemovalTime.toFixed(1) + "s";
         
         var improvementStr = "";
         var gainHrStr = "--";
         if (j > 0) {
            var delta = ((r.snr - fr.results[j-1].snr) / fr.results[j-1].snr) * 100;
            var arrow = delta > 50 ? "↑↑" : delta > 20 ? "↑ " : delta > 0 ? "↗ " : "→ ";
            improvementStr = arrow + (delta >= 0 ? "+" : "") + delta.toFixed(1) + "%";
            if (r.gainPerHour !== null && r.gainPerHour !== undefined) {
               gainHrStr = r.gainPerHour.toFixed(1) + "%/h";
            }
         } else {
            improvementStr = "(baseline)";
         }
         
         summaryContent += padRight(r.label, 12) + 
                          padRight(r.depth.toString(), 10) + 
                          padRight(totalExpStr, 15) + 
                          padRight(r.snr.toFixed(2), 10) + 
                          padRight(improvementStr, 14) + 
                          padRight(gainHrStr, 11) + 
                          timingsStr + "\n";
      }
      
      // Add insights if available
      if (fr.insights) {
         summaryContent += "\n" + "=".repeat(80) + "\n";
         summaryContent += "INSIGHTS\n";
         summaryContent += "=".repeat(80) + "\n\n";
         
         // Use the comprehensive summary generated by generateInsightsSummary()
         if (fr.insights.summary) {
            summaryContent += fr.insights.summary;
         }
      }
      
      summaryText.text = summaryContent;
      tabPage.sizer.add(summaryText);
      
      // Create preview TabBox for Graph and Stack preview
      var previewTabBox = new TabBox(tabPage);
      
      // Tab 1: Graph Preview with dropdown selector
      var graphTab = new Control(tabPage);
      graphTab.sizer = new VerticalSizer;
      graphTab.sizer.margin = 6;
      graphTab.sizer.spacing = 4;
      
      // Graph type selector row
      var graphSelectorSizer = new HorizontalSizer;
      graphSelectorSizer.spacing = 6;
      
      var graphTypeLabel = new Label(graphTab);
      graphTypeLabel.text = "Graph Type:";
      graphTypeLabel.textAlignment = TextAlign_Left | TextAlign_VertCenter;
      graphTypeLabel.minWidth = 80;
      
      var graphTypeCombo = new ComboBox(graphTab);
      graphTypeCombo.addItem("SNR vs Time");
      graphTypeCombo.addItem("Gain/hr vs Time");
      graphTypeCombo.currentItem = 0;
      graphTypeCombo.minWidth = 150;
      
      graphSelectorSizer.add(graphTypeLabel);
      graphSelectorSizer.add(graphTypeCombo);
      graphSelectorSizer.addStretch();
      
      graphTab.sizer.add(graphSelectorSizer);
      
      // Graph preview ScrollBox
      var graphPreview = new ScrollBox(graphTab);
      graphPreview.autoScroll = true;
      graphPreview.setScaledMinSize(780, 390);
      graphPreview.setScaledMaxSize(780, 390);
      
      // Store both graph paths
      var snrGraphPath = fr.graphPath;
      var gainGraphPath = fr.gainGraphPath;
      
      // Debug: Show what paths were passed
      console.writeln("Multi-filter graph paths (" + fr.filterName + ") - SNR: " + (snrGraphPath || "null") + ", Gain: " + (gainGraphPath || "null"));
      
      // Load both graphs
      var snrGraphBitmap = null;
      var gainGraphBitmap = null;
      
      if (snrGraphPath && File.exists(snrGraphPath)) {
         try {
            snrGraphBitmap = new Bitmap(snrGraphPath);
            console.writeln("SNR graph loaded (" + fr.filterName + "): " + snrGraphPath);
         } catch (e) {
            console.warningln("Failed to load SNR graph: " + e.message);
         }
      }
      
      if (gainGraphPath && File.exists(gainGraphPath)) {
         try {
            gainGraphBitmap = new Bitmap(gainGraphPath);
            console.writeln("Gain/hr graph loaded (" + fr.filterName + "): " + gainGraphPath);
         } catch (e) {
            console.warningln("Failed to load Gain/hr graph: " + e.message);
         }
      }
      
      // Store bitmaps for switching
      graphPreview.snrBitmap = snrGraphBitmap;
      graphPreview.gainBitmap = gainGraphBitmap;
      graphPreview.currentBitmap = snrGraphBitmap;
      graphPreview.statusText = snrGraphBitmap ? "" : "SNR graph not available";
      
      // Viewport paint handler
      graphPreview.viewport.onPaint = function(x0, y0, x1, y1) {
         var g = new Graphics(this);
         var bmp = this.parent.currentBitmap;
         
         if (bmp && bmp.width > 0 && bmp.height > 0) {
            // Fill background
            g.fillRect(x0, y0, x1, y1, new Brush(0xFF222222));
            
            // Calculate scale to fit viewport
            var maxWidth = 760;
            var maxHeight = 370;
            var scale = Math.min(maxWidth / bmp.width, maxHeight / bmp.height, 1.0);
            var scaledWidth = Math.floor(bmp.width * scale);
            var scaledHeight = Math.floor(bmp.height * scale);
            
            // Center the scaled bitmap
            var xOffset = Math.max(0, (this.width - scaledWidth) / 2);
            var yOffset = Math.max(0, (this.height - scaledHeight) / 2);
            
            // Draw scaled bitmap
            g.drawScaledBitmap(xOffset, yOffset, xOffset + scaledWidth, yOffset + scaledHeight, bmp);
         } else {
            // No graph available
            g.fillRect(x0, y0, x1, y1, new Brush(0xFF222222));
            g.pen = new Pen(0xFFA0A0A0);
            g.font = new Font("helvetica", 12);
            var statusText = this.parent.statusText || "Graph not available";
            g.drawText(20, 30, statusText);
         }
         
         g.end();
      };
      
      // Graph type combo change handler
      graphTypeCombo.onItemSelected = function(index) {
         if (index === 0) {
            // SNR graph
            graphPreview.currentBitmap = graphPreview.snrBitmap;
            graphPreview.statusText = graphPreview.snrBitmap ? "" : "SNR graph not available";
         } else {
            // Gain/hr graph
            graphPreview.currentBitmap = graphPreview.gainBitmap;
            graphPreview.statusText = graphPreview.gainBitmap ? "" : "Gain/hr graph not available";
         }
         graphPreview.viewport.update();
      };
      
      graphTab.sizer.add(graphPreview);
      
      previewTabBox.addPage(graphTab, "Graph");
      
      // Tab 2: Stack Preview
      var filterSuffix = (typeof fr.filterSuffix === "string") ? fr.filterSuffix : ("_" + fr.filterName.replace(/[^a-zA-Z0-9]/g, "_"));
      var stackTab = createStackPreviewPanel(
         tabPage,
         createStackPreviewEntries(fr.results, null, filterSuffix, CONFIG.generateStarless),
         false,  // Always full-frame mode
         fr.filterName
      );
      
      previewTabBox.addPage(stackTab, "Stack Preview");
      
      // Default to Graph tab
      previewTabBox.currentPageIndex = 0;
      
      tabPage.sizer.add(previewTabBox);
      
      tabBox.addPage(tabPage, fr.filterName);
   }
   
   // OK button
   var okButton = new PushButton(dialog);
   okButton.text = "OK";
   okButton.icon = dialog.scaledResource(":/icons/ok.png");
   okButton.onClick = function() {
      dialog.ok();
   };
   
   var buttonsSizer = new HorizontalSizer;
   buttonsSizer.addStretch();
   buttonsSizer.add(okButton);
   
   // Main layout
   dialog.sizer = new VerticalSizer;
   dialog.sizer.margin = 8;
   dialog.sizer.spacing = 6;
   dialog.sizer.add(tabBox, 100);
   dialog.sizer.add(buttonsSizer);
   
   dialog.adjustToContents();
   dialog.setScaledMinHeight(1000);
   dialog.execute();
}

/**
 * Helper: Pad string on the right to specified length
 */
function padRight(str, len) {
   str = str.toString();
   while (str.length < len) str += " ";
   return str;
}

/**
 * Helper: Pad string on the left to specified length
 */
function padLeft(str, len) {
   str = str.toString();
   while (str.length < len) str = " " + str;
   return str;
}
